#!/bin/bash

# ะกะบัะธะฟั ะดะปั ัะฐะทะฒะตัััะฒะฐะฝะธั Data Dashboard ะฝะฐ ัะตัะฒะตัะต

set -e

echo "๐ ะะฐัะธะฝะฐะตะผ ัะฐะทะฒะตัััะฒะฐะฝะธะต Data Dashboard..."

# ะัะพะฒะตัะบะฐ Node.js
if ! command -v node &> /dev/null; then
    echo "โ Node.js ะฝะต ัััะฐะฝะพะฒะปะตะฝ. ะฃััะฐะฝะพะฒะธัะต Node.js 18+ ะธ ะฟะพะฟัะพะฑัะนัะต ัะฝะพะฒะฐ."
    exit 1
fi

# ะัะพะฒะตัะบะฐ ะฒะตััะธะธ Node.js
NODE_VERSION=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)
if [ "$NODE_VERSION" -lt 18 ]; then
    echo "โ ะขัะตะฑัะตััั Node.js 18+. ะขะตะบััะฐั ะฒะตััะธั: $(node -v)"
    exit 1
fi

# ะัะพะฒะตัะบะฐ PM2
if ! command -v pm2 &> /dev/null; then
    echo "๐ฆ ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ PM2..."
    npm install -g pm2
fi

# ะัะพะฒะตัะบะฐ PostgreSQL
if ! command -v psql &> /dev/null; then
    echo "โ๏ธ  PostgreSQL ะฝะต ะฝะฐะนะดะตะฝ. ะฃะฑะตะดะธัะตัั, ััะพ PostgreSQL ัััะฐะฝะพะฒะปะตะฝ ะธ ะทะฐะฟััะตะฝ."
fi

# ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
echo "๐ฆ ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ..."
npm install

# ะัะพะฒะตัะบะฐ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั
if [ ! -f ".env.local" ]; then
    echo "โ๏ธ  ะคะฐะนะป .env.local ะฝะต ะฝะฐะนะดะตะฝ. ะกะพะทะดะฐะตะผ ะธะท ะฟัะธะผะตัะฐ..."
    cp .env.local .env.local.example
    echo "โ๏ธ  ะััะตะดะฐะบัะธััะนัะต .env.local ะธ ะทะฐะฟัััะธัะต ัะบัะธะฟั ัะฝะพะฒะฐ."
    exit 1
fi

# ะกะฑะพัะบะฐ ะฟัะพะตะบัะฐ
echo "๐จ ะกะพะฑะธัะฐะตะผ ะฟัะพะตะบั..."
npm run build

# ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะธ ะดะปั ะปะพะณะพะฒ
mkdir -p logs

# ะััะฐะฝะพะฒะบะฐ ะฟัะตะดัะดััะตะณะพ ะฟัะพัะตััะฐ (ะตัะปะธ ะตััั)
echo "๐ ะะตัะตะทะฐะฟััะบะฐะตะผ ะฟัะธะปะพะถะตะฝะธะต..."
pm2 stop data-dashboard 2>/dev/null || true
pm2 delete data-dashboard 2>/dev/null || true

# ะะฐะฟััะบ ั PM2
echo "๐ ะะฐะฟััะบะฐะตะผ ะฟัะธะปะพะถะตะฝะธะต ั PM2..."
pm2 start ecosystem.config.js --env production

# ะะฐัััะพะนะบะฐ ะฐะฒัะพะทะฐะฟััะบะฐ
echo "โ๏ธ  ะะฐัััะฐะธะฒะฐะตะผ ะฐะฒัะพะทะฐะฟััะบ..."
pm2 startup
pm2 save

echo "โ ะะฐะทะฒะตัััะฒะฐะฝะธะต ะทะฐะฒะตััะตะฝะพ!"
echo ""
echo "๐ ะกัะฐััั ะฟัะธะปะพะถะตะฝะธั:"
pm2 status

echo ""
echo "๐ ะัะธะปะพะถะตะฝะธะต ะดะพัััะฟะฝะพ ะฟะพ ะฐะดัะตัั: http://localhost:3000"
echo "๐ ะะพะณะธ: pm2 logs data-dashboard"
echo "๐ ะะตัะตะทะฐะฟััะบ: pm2 restart data-dashboard"
echo "โน๏ธ  ะััะฐะฝะพะฒะบะฐ: pm2 stop data-dashboard"